# Visual Generation System Upgrade

## Overview

The visual generation system has been upgraded from basic JSONB geometric specifications to detailed educational descriptions. This enhancement improves the accuracy and educational value of visuals generated by Engine 2 based on the more informative outputs from Engine 1.

## Key Changes

### 1. New Educational Visual Specification System

#### **VisualSpecification Interface**
```typescript
export interface VisualSpecification {
  educational_purpose: string;     // Specific skill/concept being tested
  visual_type: VisualType;        // Diagram category
  detailed_description: string;    // Comprehensive description of what to draw
  key_elements: string[];         // Essential components that must be present
  expected_student_interaction: string; // What students need to do
  measurement_precision: string;   // Required accuracy
  style_requirements: string;     // Visual style matching test type
  dimensions: {
    width: number;
    height: number;
  };
}
```

#### **Supported Visual Types**
- `geometric_grid_diagram` - Grid-based geometry problems
- `bar_chart` - Statistical bar charts
- `line_graph` - Line graphs and trends
- `pie_chart` - Pie charts and proportions
- `technical_drawing` - Technical diagrams
- `coordinate_plane` - Coordinate geometry
- `pattern_sequence` - Pattern recognition
- `measurement_diagram` - Measurement problems
- `algebra_illustration` - Algebraic concepts
- `statistical_display` - Statistical visualizations

### 2. Enhanced Question Generation

#### **Dual Visual System**
Questions now include both:
- **Legacy `visualData`** - For backward compatibility
- **New `visualSpecification`** - For enhanced educational context

#### **Automatic Generation**
The system automatically generates appropriate visual specifications based on:
- Sub-skill requirements
- Question context
- Difficulty level
- Test type
- Year level

### 3. Educational Context Integration

#### **Skill-Specific Visuals**
Each visual type is tailored to specific educational purposes:

**Geometry Problems:**
```typescript
// Example: Area calculation with composite shapes
{
  educational_purpose: "Calculate area of composite shapes using unit squares",
  visual_type: "geometric_grid_diagram",
  detailed_description: "Draw a grid with unit squares. Create an L-shaped figure...",
  key_elements: [
    "Unit grid with clear square divisions",
    "L-shaped composite figure made of two rectangles",
    "Dimension labels for each component"
  ],
  expected_student_interaction: "Calculate total area by counting unit squares",
  measurement_precision: "Integer unit values, composite shapes require separate calculation"
}
```

**Statistics Problems:**
```typescript
// Example: Bar chart comparison
{
  educational_purpose: "Students interpret data from bar chart to answer questions",
  visual_type: "bar_chart",
  detailed_description: "Create a horizontal grouped bar chart showing regional sales...",
  key_elements: [
    "Horizontal grouped bar chart",
    "X-axis: 0-600 scale, increments of 100",
    "Two data series with distinct colors"
  ],
  expected_student_interaction: "Compare values between years, calculate differences",
  measurement_precision: "Scale increments of 100, values to nearest 10"
}
```

### 4. Implementation Details

#### **Generation Functions**
- `generateEducationalVisualSpec()` - Main specification generator
- `generateEducationalSpecByType()` - Type-specific generators
- Specialized functions for each visual type

#### **Database Integration**
Currently stores new specifications in the `visual_data` field:
```typescript
visual_data: {
  ...legacyVisualData,
  educational_specification: visualSpecification
}
```

**Future Enhancement:** Add dedicated `visual_specification` field to database schema.

#### **Claude Prompt Integration**
Updated prompts include instructions for generating both legacy and new visual specifications:
- Detailed visual requirements
- Educational context guidelines
- Rendering specifications
- Accessibility descriptions

### 5. Benefits

#### **Enhanced Accuracy**
- More precise visual descriptions
- Educational purpose clearly defined
- Skill-specific visual elements

#### **Better Engine 2 Integration**
- Detailed descriptions improve AI visual generation
- Clear educational context guides rendering
- Consistent style requirements

#### **Backward Compatibility**
- Legacy visual data maintained
- Gradual transition possible
- Existing systems continue working

#### **Educational Value**
- Visuals aligned with learning objectives
- Clear student interaction expectations
- Appropriate difficulty progression

### 6. Usage Examples

#### **Generating Questions with Visuals**
```typescript
const request = {
  testType: 'Year 5 NAPLAN',
  yearLevel: 'Year 5',
  sectionName: 'Numeracy',
  subSkill: 'Geometry - Area and Perimeter',
  difficulty: 2,
  questionCount: 1,
  visualRequired: true
};

const response = await generateQuestions(request);
const question = response.questions[0];

// Access new visual specification
if (question.visualSpecification) {
  console.log('Educational purpose:', question.visualSpecification.educational_purpose);
  console.log('Visual type:', question.visualSpecification.visual_type);
  console.log('Key elements:', question.visualSpecification.key_elements);
}

// Legacy visual data still available
if (question.visualData) {
  console.log('Legacy type:', question.visualData.type);
  console.log('Rendering specs:', question.visualData.renderingSpecs);
}
```

#### **Accessing Stored Specifications**
```typescript
// From database
const savedQuestion = await EduCourseAPI.Question.getQuestion(questionId);
const visualSpec = savedQuestion.visual_data?.educational_specification;

if (visualSpec) {
  // Use new educational specification
  console.log('Educational purpose:', visualSpec.educational_purpose);
  console.log('Detailed description:', visualSpec.detailed_description);
}
```

### 7. Testing

Run the test script to verify the system:
```bash
npx ts-node test-visual-generation.ts
```

This will generate a sample question with both legacy and new visual specifications.

### 8. Future Enhancements

#### **Database Schema Update**
Add dedicated `visual_specification` column:
```sql
ALTER TABLE questions 
ADD COLUMN visual_specification JSONB;
```

#### **Engine 2 Integration**
Update visual rendering engine to use new specifications:
- Parse educational context
- Apply style requirements
- Generate more accurate visuals

#### **Analytics Integration**
Track visual effectiveness:
- Student interaction patterns
- Visual comprehension metrics
- Educational outcome correlation

### 9. Migration Strategy

#### **Phase 1: Dual System** (Current)
- Generate both legacy and new specifications
- Store in existing `visual_data` field
- Maintain backward compatibility

#### **Phase 2: Database Update**
- Add `visual_specification` column
- Migrate existing data
- Update API endpoints

#### **Phase 3: Engine 2 Integration**
- Update visual rendering to use new specs
- Enhance visual generation accuracy
- Implement educational context features

#### **Phase 4: Legacy Deprecation**
- Phase out legacy visual data
- Full transition to new system
- Remove backward compatibility code

## Conclusion

The new educational visual specification system provides a robust foundation for generating accurate, educationally-aligned visuals. The dual-system approach ensures smooth transition while immediately improving visual quality and educational value. 